<form method="post" class="form-x admin-form form-auto" id="form">
    <div class="tab admin-tab">
        <div class="panel admin-box fixed-pannel active">
            <div class="panel-head">
                <div class="tab-head">
                    <strong class="icon-detail"> {$info['name'] ?? ''}</strong>
                </div>
            </div>
            <div class="tab-body">
                <div class="tab-panel active" id="tab-1">
                	<div class="goodsInfo clearfix">
                        <div class="goodsPicBox float-left">
                            <span class="jqzoom clearfix" rel="gal1" title="{$info['name'] ?? ''}"><img src="{$info.thumb}" class="zoomImg" jqimg="{$info.thumb_big}" width="348"  height="348"/></span>
                            <div id="thumblist" class="clearfix">
                            {volist name="info.imgs" id="vo"}
                                <a {eq name="i" value="1"}class="zoomThumbActive"{/eq} href='javascript:void(0);' rel="{gallery: 'gal1', smallimage: '{$vo.thumb}',largeimage: '{$vo.thumb_big}'}"><img src="{$vo.thumb}" width="58"></a>
                            {/volist}
                            </div>       		
                        </div>
                        
                        <div class="goodsText">
                            <h3 class="goodsTitle">{$info.name}</h3>
                            <p class="subTitle">{$info.description}</p>
                            <div class="priceBox">
                                <p><b>价格</b><span id="price" class="text-main">￥<i id="salePrice">{$info.min_price}</i></span></p>
                            </div>
                            <div class="specBox">
                                <p><b>库存</b><span>{$info.goods_stock}</span></p>
                                {volist name="info.specs" id="vo"} <p class="spec"><b>{$vo.specname}</b> {volist name="vo.list" id="val"}<span>{$val}</span>{/volist} </p> {/volist}
                                <p class="clearfix"><b>数量</b>
                                    <span class="nums_item">
                                        <span class="nums_btn float-left icon-minus bg-main" type="del"></span><input  class="nums float-left border-main" type="number" value="1" /><span class="nums_btn float-left icon-plus bg-main" type="add"></span>
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel-foot">
                <div class="form-button" style="margin-left:385px;">
                	{notempty name="$info['sku_id']"}
                    <!--<a href="{:url('confirm', ['sku_id' => $info['sku_id'], 'num' => 1])}" class="button button-small bg-yellow">立即购买</a>-->
                    {/notempty}
                    <div class="button bg-main buy_btn">进货下单</div> <div class="button bg-dot"> 返回</div>
                </div>
            </div>
        </div>
    </div>
</form>
<script>
    Do.ready('base', function () {
        //表单综合处理
        $('#form').FormPage();  
    }); 
</script>
<script type="text/javascript">
var action = "buy";
var goods_id = "<?php echo $info['goods_id'] ?>";
var goods_total = "<?php echo $info['goods_stock'] ?>"; //库存
$(function(){
	$(".jqzoom").jqzoom({
		zoomType: 'standard',
		lens:true,
		preloadImages: false,
		alwaysOn:false,
		zoomWidth:450,
		zoomHeight:450
	});
	//选择属性
	$(".spec span").click(function(){
		$(this).parent().find(".active").removeClass("active");
		$(this).addClass("active");
		//检查属性是否选择完整
		if(checkSpec()){
			updatePrice();
		};
	})
	function checkSpec(){
		var len = $(".spec").length;
		if($(".spec").length == $(".spec .active").length){
			return true;
		}else{
			return false;
		}
	}
	function updatePrice(){
		//取得选择属性
		var specs = {};
		$(".spec").each(function(i, e) {
			var specName = $(e).find("b").text();
			var val = $(e).find(".active").text();
			specs[specName] = val;
		});
		specs = JSON.stringify(specs);
		//更新价格和库存
		var url = "/mall/getspec/id/"+goods_id;
		$.post(url,{specs:specs},function(data){
			if(data.status){
				$("#salePrice").text(data.data.price);
				$("#skuid").val(data.data.skuid);
				$("#saleSku").text(data.data.sku);
				goods_total = data.data.sku;
				if(data.data.sku <= 0){
					$("#skuText").text("库存不足");
					$(".goodsButton .button").attr('disabled',"true");
				}else{
					$(".goodsButton .button").removeAttr("disabled");
					if(data.data.sku <= 10){
						$("#skuText").text("库存紧张");
					}else{
						$("#skuText").text("");
					}
				}
			}
		})
	}
	//加入购物车
	$(".cart_btn").on("click",function(){
		addCart("cart");
	});
	//立即购买
	$(".buy_btn").on("click",function(){
		addCart("buy");
	});
	
	function addCart(action){
		if(!checkSpec()){
			layer.msg("请选择商品规格");
			return;
		}
		var skuid = $("#skuid").val();
		var str = goods_id;
		if(skuid){
			str += "/skuid/"+skuid;
		}
		if($.trim(_UID_)==''){
			window.location.href = "/login?url_forward=/mall/info/id/"+str;
			return;
		}
		var nums = $(".nums").val();
		if($.trim(goods_id)==0){
	     	layer.alert("购买商品不存在");
			return;
		}
		if($.trim(nums)<=0){
	     	layer.alert("购买商品数量不能小于1");
			return;
		}
		if($.trim(nums)>goods_total){
	     	layer.alert("剩余库存不足");
			return;
		}
		if(action == 'buy'){
			layer.msg("加入购物车成功,正在下单……",{icon:16,time:4000});
		}		
		//加入购物车回调
		var add_cart_callback = function(res){
			if(res.status){
				updateCart(goods_id,skuid,nums,res);
				get_total();
				if(action=='buy'){ 	//buy:立即购买，cart:加入购物车
					setTimeout(function(){
						window.location.href = '/confirm/index/id/'+res.cart_id;
					},3000);
				}else {
					layer.confirm(res.message,{
						btn: ['继续逛逛','<span class="icon-shopping-cart"> 去购物车结算</span>'] //按钮
					}, function(){
						layer.closeAll('dialog');
					}, function(){
						window.location.href = "/cart";
					});
				}
			}else{
				layer.alert(res.message);
			}			
		}
		
		cart.add(goods_id,skuid,nums,action,add_cart_callback);
	}
	
	//修改数量
	$(".nums_btn").on("click",function(){
		var nums = $(".nums").val();
		var type = $(this).attr("type"); //add:增加，del:减少
		if(type=="add") nums++;
		else nums--;
		if(nums <= 0) nums = 1;
		else if(nums > goods_total) nums = goods_total;
		$(".nums").val(nums);
	});
	initSpec();
});
function initSpec(){
	{present name="skuspec"}
	var skuspec = {$skuspec};
	skuspec = eval(skuspec);
	for(var data in skuspec){
		$(".spec b").each(function(i, e) {
			if($(this).text() == data){
				$(this).parent().find("span").each(function(index, element) {
					if($(this).text() == skuspec[data]){
						$(this).addClass("test");
						$(this).trigger("click");
					}
				});
			}
		});
	}
	{/present}
}
function get_total(){
	cart.total(function(res){
		$(".header-cart .cart-amount").html("￥"+res.total_amount);
		$(".header-cart .cart-nums").html(res.total_nums);
		$(".to_cart em").html(res.total_nums);
	}); 
}

function updateCart(goods_id,skuid,nums,res){
	var goodsNum = $(".header-cart .goods_list li").length;
	if(goodsNum == 0){
		$(".cart-info").html('<ul class="goods_list"></ul><div class="cart-total clearfix"><div class="left"><p>共<i class="cart-nums"></i>件商品</p><p>合计:<i class="cart-amount"></i></p></div>'+
                '<a class="button bg-main right" href="/cart">去购物车结算</a></div>');
		appendGoods(goods_id,skuid,nums,res);
	}else{
		var tis = $(".header-cart .goods_list li[data-id="+goods_id+"][skuid="+skuid+"]");
		var len = tis.length;
		if(len > 0){
			var old = tis.find(".p_num").text();
			nums = parseInt(old) + parseInt(nums);
			tis.find(".p_num").text(nums);
		}else{
			appendGoods(goods_id,skuid,nums,res);
		}
	}
}

function appendGoods(goods_id,skuid,nums,res){
	var price = '{$info.min_price}';
	var p = '';
	if(res.price) {price = res.price}
	if(res.skuspec) {p = "<p>"+res.skuspec+"</p>"}
	var html = '<li class="clearfix" data-id="'+goods_id+'" skuid="'+skuid+'">'+
                	'<div class="cart-left left">'+
                            '<img src="{$info.thumb}" width="60" class="left">'+
                            '<span>{$info.name}</span>'+p+
                    '</div>'+
                    '<div class="cart-right right">'+
                    	'<p style="margin-bottom:10px;">￥'+price+' × <span class="p_num">'+nums+'</span></p>'+
                    	'<span class="button button-small bg-main icon-trash-o right"></span>'+
                    '</div>'+
                '</li>';
	$(".cart-info .goods_list").append(html);
}

</script>